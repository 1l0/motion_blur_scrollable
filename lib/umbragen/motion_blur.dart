import 'dart:convert';
import 'dart:typed_data';
import 'dart:ui';

import 'package:umbra_flutter/umbra_flutter.dart';

/// {@template motion_blur}
/// A Flutter Widget for the `motion_blur` shader.
/// {@endtemplate}
class MotionBlur extends UmbraWidget {
  /// {@macro motion_blur}
  const MotionBlur({
    super.key,
    super.blendMode = BlendMode.src,
    super.child,
    super.errorBuilder,
    super.compilingBuilder,
    required Image tInput,
    required double delta,
    required double angle,
  })  : _tInput = tInput,
        _delta = delta,
        _angle = angle,
        super();

  static Future<FragmentProgram>? _cachedProgram;

  final Image _tInput;

  final double _delta;

  final double _angle;

  @override
  List<double> getFloatUniforms() {
    return [
      _delta,
      _angle,
    ];
  }

  @override
  List<ImageShader> getSamplerUniforms() {
    return [
      ImageShader(
        _tInput,
        TileMode.clamp,
        TileMode.clamp,
        UmbraShader.identity,
      ),
    ];
  }

  @override
  Future<FragmentProgram> program() {
    return _cachedProgram ??
        FragmentProgram.compile(
          spirv: Uint8List.fromList(base64Decode(_spirv)).buffer,
        );
  }
}

const _spirv =
    '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';
